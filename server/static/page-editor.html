<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="/static/js/gen_fingerprint.js"></script>

    <meta charset="UTF-8">
    <title>Split View HTML Editor with Code Hints</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/overlay.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/multiplex.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="/static/js/common.js"></script>
    <style>
        :root {
            --primary-color: #4a6bdf;
            --primary-hover: #3957c2;
            --secondary-color: #f8f9fa;
            --border-color: #e0e0e0;
            --text-color: #333;
            --sidebar-width: 240px;
            --toolbar-height: 54px;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --success-color: #28a745;
            --sidebar-hover: #f0f5ff;
            --active-item: #edf2ff;
            --active-text: #3957c2;
            --light-gray: #f1f1f1;
            --sidebar-bg: #f8f9fa;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            overflow: hidden;
        }

        /* Layout Components */
        .toolbar {
            position: sticky;
            top: 0;
            background-color: white;
            height: var(--toolbar-height);
            padding: 0 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            transition: margin-left 0.3s ease;
        }

        .container {
            display: flex;
            height: calc(100% - var(--toolbar-height));
        }

        .sidebar {
            position: fixed;
            left: 0;
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            z-index: 100;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 0;
        }

        .sidebar .search-box {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
        }

        .sidebar .search-box input {
            width: 90%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.2s;
            outline: none;
        }

        .sidebar .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 223, 0.25);
        }

        .titles {
            list-style: none;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .titles li {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .titles li:hover {
            background-color: var(--sidebar-hover);
        }

        .titles li.active-item {
            background-color: var(--active-item);
            color: var(--active-text);
            font-weight: 500;
            border-left: 3px solid var(--primary-color);
        }

        .toggle-sidebar {
            position: fixed;
            top: 50%;
            left: var(--sidebar-width);
            z-index: 1001;
            transform: translateY(-50%);
            width: 22px;
            height: 40px;
            background: white;
            border: 1px solid var(--border-color);
            border-left: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            transition: left 0.3s ease;
        }

        .toggle-sidebar span {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .collapsed + .toggle-sidebar {
            left: 0;
        }

        .collapsed ~ .toolbar {
            margin-left: 0;
        }

        /* Code Editor & Preview */
        .code-editor, .preview {
            height: 100%;
            overflow: hidden;
            position: relative;
            transition: width 0.3s ease;
        }

        .code-editor {
            width: 50%;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        .sidebar.collapsed ~ .container .code-editor {
            margin-left: 0;
        }

        .preview {
            width: 50%;
            border-left: 1px solid var(--border-color);
        }

        #preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .draggable {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            background-color: var(--border-color);
            cursor: ew-resize;
            z-index: 10;
        }

        /* CodeMirror Customization */
        .CodeMirror {
            height: 100%;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.5;
        }

        .CodeMirror-cursor {
            border-left: 2px solid var(--primary-color);
        }

        /* Toolbar Elements */
        .toolbar-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        .toolbar-item label {
            font-size: 14px;
            font-weight: 500;
            margin-right: 8px;
        }

        #title-display, #url-display {
            font-size: 15px;
            font-weight: 500;
            margin-right: 8px;
            color: var(--text-color);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #url-display {
            color: var(--primary-color);
            text-decoration: none;
        }

        #url-display:hover {
            text-decoration: underline;
        }

        #title-input, #url-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            outline: none;
        }

        #title-input:focus, #url-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 223, 0.25);
        }

        .edit-icon {
            cursor: pointer;
            color: #777;
            margin-left: 4px;
            transition: color 0.2s;
        }

        .edit-icon:hover {
            color: var(--primary-color);
        }

        .toolbar-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        #save-icon {
            font-size: 20px;
            color: var(--primary-color);
            cursor: pointer;
            transition: color 0.2s;
            margin-right: 5px;
        }

        #save-icon:hover {
            color: var(--primary-hover);
        }

        #save-result {
            color: var(--success-color);
            font-weight: 500;
            margin-left: 5px;
        }

        #last-modified-time {
            font-size: 13px;
            color: #777;
            margin: 0 20px;
        }

        #help-icon, #delete-icon {
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s;
            margin-left: 15px;
        }

        #help-icon {
            color: #777;
        }

        #help-icon:hover {
            color: var(--primary-color);
        }

        #delete-icon {
            color: #777;
        }

        #delete-icon:hover {
            color: var(--danger-color);
        }

        #versionsLink {
            font-size: 14px;
            color: var(--primary-color);
            text-decoration: none;
            margin-left: 15px;
        }

        #versionsLink:hover {
            text-decoration: underline;
        }

        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* Home Button */
        .floating-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.2s;
        }

        .floating-button i {
            font-size: 20px;
        }

        .floating-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* Syntax Highlighting */
        .cm-special-string {
            color: #9333ea;
            font-weight: bold;
        }

        .cm-python-delimiter {
            font-style: italic;
            color: #4f46e5;
        }

        .cm-s-default .cm-keyword {
            color: #8839ef;
            font-weight: 500;
        }

        .cm-s-default .cm-string {
            color: #d20f39;
        }

        .cm-s-default .cm-def {
            color: #1e66f5;
            font-weight: 500;
        }

        .cm-s-default .cm-variable {
            color: #04a5e5;
        }

        .cm-s-default .cm-comment {
            color: #7c7f93;
            font-style: italic;
        }

        .cm-s-default .cm-builtin {
            color: #fe640b;
        }

        .cm-s-default .cm-number {
            color: #40a02b;
        }
    </style>

    <link rel=stylesheet href="/static/css/floating_nav.css">
</head>
<body>
<!-- Home Button -->
<a href="/" id="homeButton" class="floating-button">
    <i class="fas fa-home"></i>
</a>

<!-- Sidebar -->
<div class="sidebar">
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Search pages...">
    </div>
    <ul class="titles" id="titles-list">
        <!-- List items will be dynamically loaded by JavaScript -->
    </ul>
</div>

<!-- Sidebar Toggle Button -->
<div class="toggle-sidebar" onclick="toggleSidebar()">
    <span>&laquo;</span>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <div class="toolbar-item">
        <span id="title-display">Untitled</span>
        <span id="edit-title-icon" class="edit-icon fas fa-edit"></span>
        <input type="text" id="title-input" placeholder="Edit title..." style="display: none;">
    </div>

    <div class="toolbar-item">
        <span>/pages</span>
        <a id="url-display" href="/pages/null" target="_blank">/null</a>
        <span id="edit-url-icon" class="edit-icon fas fa-edit"></span>
        <input type="text" id="url-input" placeholder="Edit URL..." style="display: none;">
    </div>

    <div class="toolbar-actions">
        <span id="save-icon" class="fas fa-save"></span>
        <span id="save-result" class="save-ok"></span>
        <span id="last-modified-time"></span>
        <a id="versionsLink" target="_blank" href="/page-versions">Versions</a>
        <span id="help-icon" title="See documentation" class="fas fa-question-circle" onclick="window.open('https://github.com/zhouzhipeng/play/blob/main/doc/page-editor-usage.md')"></span>
        <span id="delete-icon" class="fas fa-trash"></span>
    </div>
</div>

<!-- Main Container -->
<div class="container" id="container">
    <div class="code-editor">
        <div id="loading-indicator" style="display:none;">Loading...</div>
        <div id="htmlCodeEditor" style="height: 100%"></div>
    </div>
    <div class="preview">
        <iframe id="preview-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
</div>

<script>
    let startX, startWidth;
    window.addEventListener('beforeunload', function(e) {
        // 取消事件
        e.preventDefault();
        // Chrome 需要 returnValue 设置
        e.returnValue = '';
        // 返回一个字符串（注意：现代浏览器通常会忽略自定义消息而显示标准消息）
        return '确定要离开此页面吗？';
    });
    function startResizing(e) {
        e.preventDefault();
        startX = e.clientX;
        startWidth = document.querySelector('.code-editor').offsetWidth;
        document.addEventListener('mousemove', resize, false);
        document.addEventListener('mouseup', stopResizing, false);
    }

    function resize(e) {
        e.preventDefault();
        const codeEditor = document.querySelector('.code-editor');
        const previewArea = document.querySelector('.preview');
        const previewIframe = document.getElementById('preview-iframe');
        const containerWidth = document.getElementById('container').offsetWidth;

        const newWidth = Math.max(startWidth + e.clientX - startX, 0); // 防止宽度为负
        const newPreviewWidth = Math.max(containerWidth - newWidth, 0); // 同样防止负值

        codeEditor.style.width = newWidth + 'px';
        previewArea.style.width = newPreviewWidth + 'px';
        previewIframe.style.width = newPreviewWidth + 'px'; // 确保iframe响应调整
    }

    function stopResizing() {
        document.removeEventListener('mousemove', resize, false);
        document.removeEventListener('mouseup', stopResizing, false);
    }

    // 定义复制当前行的函数
    function duplicateLine(cm) {
        // 获取当前光标所在的行
        var cursor = cm.getCursor();
        // 获取当前行的内容
        var lineContent = cm.getLine(cursor.line);
        // 插入当前行内容到下一行
        cm.replaceRange(lineContent + "\n", { line: cursor.line + 1, ch: 0 });
    }





    CodeMirror.defineMode("htmlWithPython", function(config) {
        return CodeMirror.multiplexingMode(
            CodeMirror.getMode(config, "htmlmixed"), // 主模式是HTML
            {open: "<%", close: "%>", mode: CodeMirror.getMode(config, "text/x-python"), delimStyle: "python-delimiter"}, // Python代码块
            {open: "%", close: "", mode: CodeMirror.getMode(config, "text/x-python"), delimStyle: "python-delimiter"}, // Python代码块
            {open: "{{", close: "}}", mode: CodeMirror.getMode(config, "text/x-python"), delimStyle: "python-delimiter"}, // Python代码块
            // 添加更多嵌入模式
        );
    });

    // 获取CodeMirror实例，假设你已经创建了editor
    // var editor = CodeMirror.fromTextArea(document.getElementById('myTextarea'), {mode: 'text/html'});

    // 将自定义覆盖应用到现有的模式上
    CodeMirror.defineMode("myOverlay", function(config, parserConfig) {
        return CodeMirror.overlayMode(CodeMirror.getMode(config, parserConfig.backdrop || "htmlWithPython"),      {token: function(stream, state) {
                // 正则表达式匹配 <special> 或 </special>
                var re = /({{)|(}})|(%>)|%|(<%)|(^end$)/;
                if (stream.match(re)) {
                    // 返回自定义样式
                    return "special-string";
                }
                while (stream.next() != null && !stream.match(re, false)) {}
                return null;
            }});
    });


    var editor = CodeMirror(document.getElementById('htmlCodeEditor'), {
        mode: "myOverlay",
        backdrop: "htmlWithPython",
        theme: 'default',
        lineNumbers: true,
        autoCloseTags: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        // scrollbarStyle: 'overlay', // 或者 'null' 根据您的需要设置
        lineWrapping: false,
        viewportMargin: Infinity, // Ensures the entire document is always rendered
        hintOptions: {autoHint: true},

    });

    editor.on("inputRead", function(cm, change) {

        if (change.origin === "+input"
            && change.text[0]!=="%"
            && change.text[0]!==":"
            && change.text[0]!==";"
            && !cm.state.completionActive && !/\s/.test(change.text[0])) {
            CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
        }
    });

    // editor.on("change", function() {
    //     document.getElementById("htmlPreview").innerHTML = editor.getValue();
    // });

    var beginAutocomplte=false;


    var textChanged =false;

    // 绑定keydown事件监听器
    // editor.on("keydown", function(cm, event) {
    //
    // });
    editor.on('change', function(instance, changeObj) {
        textChanged =true;
        if (changeObj.origin === '+input' && changeObj.text[0] === '<') {
            beginAutocomplte =true;
        }else if (beginAutocomplte && changeObj.origin === '+input') {
            if( changeObj.text[0] === '%'){
                beginAutocomplte =false;
                var cursor = instance.getCursor();
                // 在当前光标位置插入 '%>'
                instance.replaceRange('\n\n%>', cursor);
                // 将光标移到 '<%' 和 '%>' 之间
                instance.setCursor({line: cursor.line+1, ch: cursor.ch});

            }else{
                beginAutocomplte =false;
            }

        }

        // document.getElementById("htmlPreview").innerHTML = editor.getValue();
    });

    // 添加自定义命令并重新绑定 Ctrl-D / Cmd-D
    editor.addKeyMap({
        'Ctrl-D': function(cm) { duplicateLine(cm); },
        'Cmd-D': function(cm) { duplicateLine(cm); },
        'Shift-Ctrl-D': false,  // 可以尝试禁用原有的绑定，如果有的话
        'Shift-Cmd-D': false    // 同上，针对 Mac 用户
    });


    function updatePreview(content) {
        const iframe = document.getElementById('preview-iframe');
        // const doc = iframe.contentWindow.document;
        // // 清空 iframe
        // doc.open();
        // doc.close();
        const blob = new Blob([content], { type: 'text/html' });
        const blobUrl = URL.createObjectURL(blob);
        iframe.src = blobUrl;

        //write 方式会导致js变量声明重复定义
        // doc.open();
        // doc.write(content); // 将HTML内容写入iframe
        // doc.close();
    }


    var isCallingAPI=false
    function generate_preview_page(){
        const urlElement = document.getElementById('url-display');
        if(urlElement.innerText.endsWith(".html")){
            //static pages
            updatePreview(editor.getValue());
            isCallingAPI=false
            return;
        }

        isCallingAPI=true
        let data = new URLSearchParams();
        data.append( "s", editor.getValue());

        try {
            fetch("/functions/str-joiner",
                {
                    method: "POST",
                    body: data,
                    headers: {'Content-Type': 'application/x-www-form-urlencoded', 'Hx-Request':"true"},

                }).then(res=>res.text())
                .then(result=>{
                    updatePreview(result);
                    isCallingAPI=false

                })

        }catch (e) {
            console.error(e);
            isCallingAPI=false
        }
    }


    //auto refresh preview page
    setInterval(()=>{
        if(textChanged && !isCallingAPI){
            textChanged =false;
            generate_preview_page()
        }

    }, 100)

    //
    // // 处理搜索逻辑
    // document.getElementById('search-input').addEventListener('input', function() {
    //     var query = this.value;
    //     if (!query) {
    //         document.getElementById('search-results').style.display = 'none';
    //         return;
    //     }
    //
    //     // 这里使用 fetch 发起 API 调用，您可能需要根据您的 API 调整 URL 和参数
    //     fetch('/data/pages/query?title=' + encodeURIComponent(query))
    //         .then(response => response.json())
    //         .then(data => {
    //             var resultsBox = document.getElementById('search-results');
    //             resultsBox.innerHTML = ''; // 清空当前结果
    //             data.forEach(item => {
    //                 var div = document.createElement('div');
    //                 div.textContent = item.title; // 假设返回的结果有一个 'title'
    //                 div.addEventListener('click', function() {
    //                     editor.setValue(item.content); // 假设结果有 'content'
    //                     resultsBox.style.display = 'none'; // 隐藏结果列表
    //                 });
    //                 resultsBox.appendChild(div);
    //             });
    //             resultsBox.style.display = 'block'; // 显示结果
    //         });
    // });

</script>
<script>
    // 获取所有标题元素
    const titles = document.querySelectorAll('.titles li');
    // 为每个标题添加点击事件
    titles.forEach(title => {
        title.addEventListener('click', function() {
            // 假设每个标题对应的内容存储在某处，这里用一个简单的映射作为示例
            const titleContentMap = {
                '标题1': '这是标题1的内容...',
                '标题2': '这是标题2的内容...',
                '标题3': '这是标题3的内容...',
                // 添加更多标题与内容的映射
            };

            // 移除之前所有条目的高亮样式
            document.querySelectorAll('.titles li.active').forEach(activeItem => {
                activeItem.classList.remove('active');
            });

            // 给被点击的条目添加高亮样式
            this.classList.add('active');

            document.getElementById("title-display").textContent=this.textContent;
            // 获取并设置对应标题的内容到编辑器
            editor.setValue(titleContentMap[this.textContent] || '未找到内容');
        });
    });

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('collapsed');
        const toggleIcon = document.querySelector('.toggle-sidebar span');
        // 更新图标或文本等，根据实际情况
        if (sidebar.classList.contains('collapsed')) {
            toggleIcon.innerHTML = '&raquo;'; // 或其他表示展开的图标
        } else {
            toggleIcon.innerHTML = '&laquo;'; // 或其他表示折叠的图标
        }

        // 可选：根据侧边栏状态调整编辑器宽度等
        const editor = document.querySelector('.code-editor');
        const toolbar = document.querySelector('.toolbar');
        if (sidebar.classList.contains('collapsed')) {
            // 把编辑器宽度调整为全屏
            editor.style.marginLeft = "0px";
            toolbar.style.marginLeft = "0px";
        } else {
            // 还原编辑器的宽度，减去侧边栏的宽度
            editor.style.marginLeft = "240px";
            toolbar.style.marginLeft = "240px";
        }

        // 调整完大小后刷新CodeMirror实例
        window.editor.refresh();

    }


</script>
<script>
    document.getElementById('search-input').addEventListener('input', function() {
        const filter = this.value.toUpperCase();
        const titles = document.querySelectorAll('.titles li');

        titles.forEach(title => {
            const text = title.textContent || title.innerText;
            if (text.toUpperCase().indexOf(filter) > -1) {
                title.style.display = "";
            } else {
                title.style.display = "none";
            }
        });
    });
</script>
<script>
    document.getElementById('edit-title-icon').addEventListener('click', function() {
        toggleEdit('title');
    });

    document.getElementById('edit-url-icon').addEventListener('click', function() {
        toggleEdit('url');
    });

    function toggleEdit(type) {
        const display = document.getElementById(`${type}-display`);
        const input = document.getElementById(`${type}-input`);
        const icon = document.getElementById(`edit-${type}-icon`);

        if (input.style.display === 'none') {
            display.style.display = 'none';
            icon.style.display = 'none';
            input.style.display = 'block';
            input.value = display.textContent;
            input.focus();
        } else {
            updateField(type);
        }
    }

    function updateField(type) {
        const input = document.getElementById(`${type}-input`);
        const display = document.getElementById(`${type}-display`);

        if (input.value.trim() !== '') {
            display.textContent = input.value.trim();
            display.href = "/pages"+input.value.trim();
        }
        input.style.display = 'none';
        display.style.display = 'block';
        document.getElementById(`edit-${type}-icon`).style.display = 'block';
    }
    function dontUpdateField(type) {
        const input = document.getElementById(`${type}-input`);
        const display = document.getElementById(`${type}-display`);

        input.style.display = 'none';
        display.style.display = 'block';
        document.getElementById(`edit-${type}-icon`).style.display = 'block';
    }

    document.getElementById('title-input').addEventListener('blur', function() {
        updateField('title');
    });

    document.getElementById('url-input').addEventListener('blur', function() {
        updateField('url');
    });

    document.querySelectorAll('.toolbar input').forEach(input => {
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                //save
                // console.log("save title")
                updateField('title');
                updateField('url');
            }
        });
    });
</script>


<script>
    //删除按钮操作
    document.getElementById('delete-icon').addEventListener('click', async function() {
        // 确认是否删除
        const isConfirmed = confirm('确定要删除吗？');
        if (isConfirmed) {
            // 用户确认删除，执行删除操作
            try {
                const response = await fetch(`/data/id/${currentSelectedId}`, {
                    method: 'DELETE', // 使用DELETE方法
                });
                if (response.ok) {
                    console.log('删除成功');
                    // 删除成功，重新加载页面
                    location.reload();
                } else {
                    // 删除失败，打印错误信息
                    console.error('删除失败:', response.statusText);
                    alert('删除失败: ' + response.statusText); // 提示用户
                }
            } catch (error) {
                console.error('删除过程中发生错误:', error);
                alert('删除异常: ' + error.message); // 提示用户
            }
        } else {
            // 用户取消删除操作
            console.log('删除操作已取消');
        }
    });

</script>

<script>
    let currentSelectedId = null; // 用于存储当前选中的列表项ID

    // 定义一个函数，用于根据ID获取内容并更新编辑器
    function fetchItemContent(id) {
        // 显示加载指示器
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';
        fetch(`/data/id/${id}`)
            .then(response => response.json())
            .then(data => {
                data = data[0];
                // 假设返回的数据结构与列表接口一致
                const itemData = JSON.parse(data.data); // 根据实际返回结构可能需要调整
                const content = hexToString(itemData.content); // 对内容进行hex解码
                editor.setValue(content); // 更新CodeMirror编辑器的内容

                // 更新标题和URL等其他相关字段
                document.getElementById('title-display').textContent = itemData.title;
                document.getElementById('url-display').textContent = itemData.url;
                document.getElementById('last-modified-time').textContent = `updated: ${formatTimestamp(data.updated)}`;
                document.getElementById('versionsLink').href = `/page-versions?data_id=${data.id}`;
            })
            .catch(error => console.error('获取内容失败:', error))
            .finally(() => {
                // 隐藏加载指示器
                loadingIndicator.style.display = 'none';
            });
    }

    // 定义用于加载列表数据和更新编辑区的函数
    async function loadListData() {
        try {
            // 发送请求获取数据
            const response = await fetch('/data/cat/pages?_select=title,url&_limit=100');
            if (!response.ok) {
                throw new Error('数据加载失败');
            }
            const listData = await response.json(); // 解析JSON数据

            // 获取列表元素
            const listElement = document.getElementById('titles-list');
            listElement.innerHTML = ''; // 清空当前列表

            // 遍历数据数组，为每一项创建一个列表项
            listData.forEach(item => {
                // 反序列化data字段为JSON对象
                const itemData = JSON.parse(item.data);

                // 创建列表项
                const listItem = document.createElement('li');
                listItem.textContent = itemData.title; // 设置列表项的文本为title字段
                listItem.classList.add('title-item'); // 添加样式类
                listItem.setAttribute('data-id', item.id); // 设置数据ID属性

                // 为列表项添加点击事件监听器
                listItem.addEventListener('click', () => {
                    // 更新当前选中的条目ID
                    currentSelectedId = item.id;
                    // 移除先前所有项的高亮样式
                    document.querySelectorAll('.titles li').forEach(el => {
                        el.classList.remove('active-item');
                    });

                    // 给当前点击的列表项添加高亮样式
                    listItem.classList.add('active-item');

                    updateEditor(itemData, item); // 点击时更新编辑器和相关字段
                });

                listElement.appendChild(listItem); // 将列表项添加到列表中
            });
        } catch (error) {
            console.error('加载列表数据时发生错误:', error);
        }
    }

    // 定义一个根据ID高亮列表项的函数
    function highlightListItem(id) {
        // 首先移除所有项的高亮样式
        document.querySelectorAll('.titles li').forEach(el => {
            el.classList.remove('active-item');
        });

        // 根据存储的ID找到对应的列表项并添加高亮样式
        const itemToHighlight = document.querySelector(`.titles li[data-id="${id}"]`);
        if (itemToHighlight) {
            itemToHighlight.classList.add('active-item');
        }
    }



    // 定义用于更新编辑器和相关字段的函数
    function updateEditor(itemData, item) {
        document.getElementById('title-display').textContent = itemData.title; // 更新标题
        document.getElementById('last-modified-time').textContent = `updated: ${formatTimestamp(item.updated)}`; // 更新updated

        // 更新URL链接和文本
        const urlElement = document.getElementById('url-display');
        urlElement.href = "/pages"+ itemData.url; // 设置超链接的地址
        urlElement.textContent = itemData.url; // 设置超链接的文本，也可以设置为更友好的描述

        fetchItemContent(item.id)
    }


    // 加载列表数据
    document.addEventListener('DOMContentLoaded', loadListData);

</script>

<script>
    const saveResultElement = document.getElementById('save-result'); // 获取显示结果的元素

    async function saveData() {
        // 获取标题、URL和代码编辑器内容
        const title = document.getElementById('title-display').textContent;
        const url = document.getElementById('url-display').textContent;
        const codeContent = editor.getValue(); // 假设您的CodeMirror实例变量名为editor


        // 构造请求的body
        const requestBody = {
            title: title,
            url: url,
            content: stringToHex(codeContent)
        };

        try {
            let url = currentSelectedId ?`/data/id/${currentSelectedId}` :'/data/cat/pages';
            let method = currentSelectedId ? "PUT":"POST";
            // 发送保存请求
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            // 检查响应状态
            if (response.ok) {
                if(!currentSelectedId){
                    location.reload();
                }
                console.log('数据保存成功');
                // 这里可以添加更多成功保存后的操作

                // 更新显示结果的元素
                saveResultElement.textContent = 'OK';
                saveResultElement.style.display = 'inline'; // 确保结果可见

                // 隐藏结果信息后一段时间
                setTimeout(() => {
                    saveResultElement.style.display = 'none';
                }, 2000); // 2秒后隐藏

                // 数据保存成功后，重新加载列表数据
                await loadListData();

                // 如果之前有选中的列表项，重新高亮显示
                if (currentSelectedId) {
                    highlightListItem(currentSelectedId);
                }
            } else {
                // 处理保存失败的情况
                console.error('保存失败:', response.statusText);
                saveResultElement.textContent = '保存失败'; // 更新保存结果
                saveResultElement.style.display = 'inline';
                setTimeout(() => {
                    saveResultElement.style.display = 'none';
                }, 2000); // 2秒后隐藏
            }
        } catch (error) {
            console.error('保存过程中发生错误:', error);
            // 这里可以添加错误处理逻辑
        }
    }

    document.getElementById('save-icon').addEventListener('click', saveData);

</script>
</body>
</html>