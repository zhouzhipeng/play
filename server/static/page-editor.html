<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Split View HTML Editor with Code Hints</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/overlay.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/multiplex.min.js"></script>


    <style>
        * {
            box-sizing: border-box;
        }
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .toolbar {
            background-color: #f1f1f1;
            padding: 10px 16px;
            display: flex;
            align-items: center;
        }
        .save-btn, .search-input {
            padding: 8px;
            margin-right: 10px;
        }
        .container {
            display: flex;
            height: calc(100% - 40px);
        }
        .code-editor, .preview {
            overflow: auto;
            height: 100%;
        }
        .code-editor {
            width: 50%; /* Default width */
            height: 100%;
            position: relative; /* For resizable handle */
        }
        .preview {
            background-color: #fff;
            width: 50%;
            overflow: auto;
            font-size: 18px; /* Adjust the font size as needed */

        }
        .draggable {
            background-color: #ccc;
            width: 5px;
            cursor: ew-resize;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
        }
        .CodeMirror {
            border: 1px solid #eee;
            height: 100%;
            width: 100%;
            font-size: 16px; /* Adjust the font size as needed */

        }

        /* 增加光标的可见性 */
        .CodeMirror-cursor {
            border-left: 2px solid black; /* 使光标更宽并更明显 */
            border-right: none;
            color: red; /* 也可以设置一个明显的颜色 */
            background-color: yellow; /* 可以设置背景色增加可见性 */
        }

        /* 当编辑器失去焦点时也显示光标（可选）*/
        .CodeMirror div.CodeMirror-cursors {
            visibility: visible;
        }


        /* 定义特殊标签的样式 */
        .cm-special-string { color: purple; font-weight: bold; }
        .cm-python-delimiter { font-style: italic; }


        /* 关键字 */
        .cm-s-default .cm-keyword {
            color: #708;
        }

        /* 字符串 */
        .cm-s-default .cm-string {
            color: #a22;
        }

        /* 类和函数名 */
        .cm-s-default .cm-def {
            color: #00f;
        }

        /* 变量和属性 */
        .cm-s-default .cm-variable {
            color: #002b88;
        }

        /* 注释 */
        .cm-s-default .cm-comment {
            color: #a50;
        }

        /* 内置 */
        .cm-s-default .cm-builtin {
            color: #30a;
        }

        /* 数字 */
        .cm-s-default .cm-number {
            color: #164;
        }


        .search-results {
            border: 1px solid #ccc;
            position: absolute;
            top: 50px; /* Adjust based on your layout */
            width: 180px; /* Match the width of your search input */
            display: none; /* Hide the box by default */
            z-index: 100;
        }

        .search-results div {
            padding: 5px;
            cursor: pointer;
        }

        .search-results div:hover {
            background-color: #f0f0f0;
        }


        /* 工具栏样式 */
        .toolbar {
            background-color: #f8f9fa; /* 设置工具栏背景颜色 */
            padding: 10px 16px; /* 设置内边距 */
            display: flex; /* 使用flex布局 */
            align-items: center; /* 垂直居中对齐工具栏项 */
            border-bottom: 1px solid #e0e0e0; /* 在工具栏底部添加边界线 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 添加轻微的阴影 */
        }

        /* 搜索输入框样式 */
        .toolbar .search-input {
            padding: 8px 12px; /* 设置填充 */
            border: 1px solid #ddd; /* 设置边界 */
            border-radius: 20px; /* 设置边框圆角 */
            margin-right: 8px; /* 设置右边距 */
            width: 200px; /* 设置宽度 */
            outline: none; /* 移除焦点轮廓 */
        }

        .toolbar .search-input:focus {
            border-color: #80bdff; /* 输入框聚焦时改变边界颜色 */
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* 添加聚焦时的阴影 */
        }

        /* 保存按钮样式 */
        .toolbar .save-btn {
            padding: 6px 12px; /* 设置填充 */
            background-color: #007bff; /* 设置背景颜色 */
            color: white; /* 设置文字颜色 */
            border: none; /* 移除边界 */
            border-radius: 4px; /* 设置边框圆角 */
            cursor: pointer; /* 设置鼠标样式 */
        }

        .toolbar .save-btn:hover {
            background-color: #0056b3; /* 鼠标悬停时改变背景颜色 */
        }

        /* 基础布局样式 */
        .sidebar {
            width: 200px;
            border-right: 1px solid #ddd;
            height: 100vh; /* 视口高度 */
            overflow-y: auto; /* 添加滚动条 */
            float: left;
        }

        .toolbar {
            margin-left: 200px; /* 与侧边栏宽度一致 */
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        /* 标题列表样式 */
        .titles {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .titles li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .titles li:hover {
            background-color: #f0f0f0;
        }

        /* 编辑器和输入框样式 */
        .code-editor {
            margin-left: 200px; /* 与侧边栏宽度一致 */
            /*width: calc(100% - 200px); !* 减去侧边栏宽度 *!*/
            height: calc(100vh - 42px); /* 调整高度 */
            resize: none; /* 禁止调整大小 */
        }

        #title-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box; /* 输入框的宽度包括内边距和边框 */
        }

        .toggle-sidebar {
            position: absolute; /* 调整为你的页面布局 */
            top: 50%; /* 根据需要调整 */
            left: 200px; /* 侧边栏宽度，根据需要调整 */
            transform: translateY(-50%);
            cursor: pointer;
            background-color: #f8f9fa; /* 背景颜色，提高可见性 */
            padding: 5px; /* 调整大小，确保可以看见 */
            z-index: 1000; /* 确保它在最前面 */
            font-size: 20px; /* 增大图标字体大小 */
            width: 30px; /* 调整宽度 */
            height: 30px; /* 调整高度 */
            text-align: center; /* 确保图标居中 */

        }

        .collapsed {
            width: 0;
            overflow: hidden; /* 折叠侧边栏时隐藏内容 */
        }

        /* 根据侧边栏状态调整编辑器和工具栏的边距 */
        .collapsed + .toggle-sidebar {
            left: 0;
        }
        .collapsed ~ .toolbar, .collapsed ~ #code-editor {
            margin-left: 20px; /* 当侧边栏折叠时调整左边距 */
        }

        .sidebar {
            position: fixed;
            left: 0;
            width: 200px;
            bottom: 0;
            overflow-y: auto;
            background-color: #fff;
            z-index: 500;
            border-right: 1px solid #ddd;
            padding: 10px 0; /* 添加顶部和底部的内边距 */
        }

        .search-box {
            padding: 10px; /* 根据需要调整内边距 */
        }

        .search-box input {
            width: calc(100% - 20px); /* 减去内边距的宽度 */
            padding: 8px;
            /*margin-bottom: 20px; !* 在搜索框和列表之间添加一些间距 *!*/
            box-sizing: border-box;
            border: 1px solid #ddd; /* 添加边框 */
            border-radius: 4px; /* 添加边框圆角 */
        }

        .titles {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .titles li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .titles li:hover {
            background-color: #f0f0f0;
        }

        /* 侧边栏样式 */
        .sidebar {
            position: fixed;
            left: 0;
            width: 200px; /* 或其他宽度，根据需要调整 */
            bottom: 0;
            overflow-y: auto;
            /*transition: all 0.3s; !* 平滑过渡效果 *!*/
        }

        /* 侧边栏折叠时的样式 */
        .sidebar.collapsed {
            width: 0; /* 改变宽度来折叠侧边栏 */
            overflow-x: hidden; /* 防止内容溢出 */
        }

        /* 调整折叠按钮的位置 */
        .toggle-sidebar {
            position: fixed;
            top: 50%; /* 居中 */
            left: 200px; /* 与侧边栏宽度相同 */
            transform: translateY(-50%); /* 确保垂直居中 */
            cursor: pointer;
            /* 其他样式 */
        }

        /* 当侧边栏折叠时调整按钮位置 */
        .sidebar.collapsed + .toggle-sidebar {
            left: 0; /* 移动按钮到页面边缘 */
        }


        /* 左侧列表条目的基本样式 */
        .titles li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        /* 被点击条目的高亮样式 */
        .titles li.active {
            background-color: #007bff; /* 选择一个高亮颜色 */
            color: white; /* 改变文字颜色以确保可读性 */
        }

    </style>
</head>
<body>
<div class="sidebar">
    <div class="search-box">
        <input type="text" id="search-input" placeholder="搜索标题...">
    </div>
    <ul class="titles">
        <li>标题1</li>
        <li>标题2</li>
        <li>标题3</li>
        <!-- 添加更多标题 -->
    </ul>
</div>

<div class="toggle-sidebar" onclick="toggleSidebar()">
    <span>&laquo;</span> <!-- 使用左箭头作为折叠图标，您可以替换为任何图标 -->
</div>

<div class="toolbar">
    <input type="text" id="title-input" placeholder="标题">
    <button class="save-btn" onclick="saveCode()">Save</button>
</div>
<div class="container" id="container">

    <div class="code-editor">
        <div id="htmlCodeEditor" style="height: 100%"></div> <!-- CodeMirror will attach here -->
        <div class="draggable" onmousedown="startResizing(event)"></div>
    </div>
    <div class="preview" id="htmlPreview"></div>
</div>

<script>
    let startX, startWidth;

    function startResizing(e) {
        startX = e.clientX;
        startWidth = document.querySelector('.code-editor').offsetWidth;
        document.addEventListener('mousemove', resize, false);
        document.addEventListener('mouseup', stopResizing, false);
    }

    function resize(e) {
        const codeEditor = document.querySelector('.code-editor');
        const containerWidth = document.getElementById('container').offsetWidth;
        const newWidth = startWidth + e.clientX - startX;
        codeEditor.style.width = newWidth + 'px';
        document.querySelector('.preview').style.width = containerWidth - newWidth + 'px';
    }

    function stopResizing() {
        document.removeEventListener('mousemove', resize, false);
        document.removeEventListener('mouseup', stopResizing, false);
    }


    function saveCode() {
        // Implement save functionality here
        alert('Code saved! (Placeholder function)');
    }

    // 定义复制当前行的函数
    function duplicateLine(cm) {
        // 获取当前光标所在的行
        var cursor = cm.getCursor();
        // 获取当前行的内容
        var lineContent = cm.getLine(cursor.line);
        // 插入当前行内容到下一行
        cm.replaceRange(lineContent + "\n", { line: cursor.line + 1, ch: 0 });
    }





    CodeMirror.defineMode("htmlWithPython", function(config) {
        return CodeMirror.multiplexingMode(
            CodeMirror.getMode(config, "text/html"), // 主模式是HTML
            {open: "<%", close: "%>", mode: CodeMirror.getMode(config, "text/x-python"), delimStyle: "python-delimiter"}, // Python代码块
            {open: "%", close: "", mode: CodeMirror.getMode(config, "text/x-python"), delimStyle: "python-delimiter"}, // Python代码块
            {open: "{{", close: "}}", mode: CodeMirror.getMode(config, "text/x-python"), delimStyle: "python-delimiter"}, // Python代码块
            // 添加更多嵌入模式
        );
    });

    // 获取CodeMirror实例，假设你已经创建了editor
    // var editor = CodeMirror.fromTextArea(document.getElementById('myTextarea'), {mode: 'text/html'});

    // 将自定义覆盖应用到现有的模式上
    CodeMirror.defineMode("myOverlay", function(config, parserConfig) {
        return CodeMirror.overlayMode(CodeMirror.getMode(config, parserConfig.backdrop || "htmlWithPython"),      {token: function(stream, state) {
            // 正则表达式匹配 <special> 或 </special>
            var re = /({{)|(}})|(%>)|%|(<%)|(end)/;
            if (stream.match(re)) {
                // 返回自定义样式
                return "special-string";
            }
            while (stream.next() != null && !stream.match(re, false)) {}
            return null;
        }});
    });


    var editor = CodeMirror(document.getElementById('htmlCodeEditor'), {
        mode: "myOverlay",
        backdrop: "htmlWithPython",
        theme: 'default',
        lineNumbers: true,
        autoCloseTags: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        lineWrapping: true,
        viewportMargin: Infinity, // Ensures the entire document is always rendered
        hintOptions: {autoHint: true},

    });

    editor.on("inputRead", function(cm, change) {
         if (change.origin === "+input"  && change.text[0]!=="%"&& change.text[0]!==":" && !cm.state.completionActive && !/\s/.test(change.text[0])) {
            CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
        }
    });

    // editor.on("change", function() {
    //     document.getElementById("htmlPreview").innerHTML = editor.getValue();
    // });

    var beginAutocomplte=false;

    var textChanged =false;
    editor.on('change', function(instance, changeObj) {
        textChanged =true;
        if (changeObj.origin === '+input' && changeObj.text[0] === '<') {
            beginAutocomplte =true;
        }

        if (beginAutocomplte && changeObj.origin === '+input' && changeObj.text[0] === '%') {
            beginAutocomplte =false;
            var cursor = instance.getCursor();
            // 在当前光标位置插入 '%>'
            instance.replaceRange('\n\n%>', cursor);
            // 将光标移到 '<%' 和 '%>' 之间
            instance.setCursor({line: cursor.line+1, ch: cursor.ch});

        }

        // document.getElementById("htmlPreview").innerHTML = editor.getValue();
    });

    // 添加自定义命令并重新绑定 Ctrl-D / Cmd-D
    editor.addKeyMap({
        'Ctrl-D': function(cm) { duplicateLine(cm); },
        'Cmd-D': function(cm) { duplicateLine(cm); },
        'Shift-Ctrl-D': false,  // 可以尝试禁用原有的绑定，如果有的话
        'Shift-Cmd-D': false    // 同上，针对 Mac 用户
    });



    var shouldCallGenerate=true
    function generate_preview_page(){
        if(!editor.getValue()){
            return;
        }
        shouldCallGenerate=false
        let data = new URLSearchParams();
        data.append( "s", editor.getValue());

        try {
            fetch("/functions/str-joiner",
                {
                    method: "POST",
                    body: data,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(res=>res.text())
                .then(result=>{
                    document.getElementById("htmlPreview").innerHTML = result;
                    shouldCallGenerate=true
                    textChanged =false;
                })

        }catch (e) {
            console.error(e);
        }
    }


    //auto refresh preview page
    setInterval(()=>{
        if(textChanged && shouldCallGenerate){
            generate_preview_page()
        }

    }, 1000)

    //
    // // 处理搜索逻辑
    // document.getElementById('search-input').addEventListener('input', function() {
    //     var query = this.value;
    //     if (!query) {
    //         document.getElementById('search-results').style.display = 'none';
    //         return;
    //     }
    //
    //     // 这里使用 fetch 发起 API 调用，您可能需要根据您的 API 调整 URL 和参数
    //     fetch('/data/pages/query?title=' + encodeURIComponent(query))
    //         .then(response => response.json())
    //         .then(data => {
    //             var resultsBox = document.getElementById('search-results');
    //             resultsBox.innerHTML = ''; // 清空当前结果
    //             data.forEach(item => {
    //                 var div = document.createElement('div');
    //                 div.textContent = item.title; // 假设返回的结果有一个 'title'
    //                 div.addEventListener('click', function() {
    //                     editor.setValue(item.content); // 假设结果有 'content'
    //                     resultsBox.style.display = 'none'; // 隐藏结果列表
    //                 });
    //                 resultsBox.appendChild(div);
    //             });
    //             resultsBox.style.display = 'block'; // 显示结果
    //         });
    // });

</script>
<script>
    // 获取所有标题元素
    const titles = document.querySelectorAll('.titles li');
    // 为每个标题添加点击事件
    titles.forEach(title => {
        title.addEventListener('click', function() {
            // 假设每个标题对应的内容存储在某处，这里用一个简单的映射作为示例
            const titleContentMap = {
                '标题1': '这是标题1的内容...',
                '标题2': '这是标题2的内容...',
                '标题3': '这是标题3的内容...',
                // 添加更多标题与内容的映射
            };

            // 移除之前所有条目的高亮样式
            document.querySelectorAll('.titles li.active').forEach(activeItem => {
                activeItem.classList.remove('active');
            });

            // 给被点击的条目添加高亮样式
            this.classList.add('active');
            // 获取并设置对应标题的内容到编辑器
            editor.setValue(titleContentMap[this.textContent] || '未找到内容');
        });
    });

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('collapsed');
        const toggleIcon = document.querySelector('.toggle-sidebar span');
        // 更新图标或文本等，根据实际情况
        if (sidebar.classList.contains('collapsed')) {
            toggleIcon.innerHTML = '&raquo;'; // 或其他表示展开的图标
        } else {
            toggleIcon.innerHTML = '&laquo;'; // 或其他表示折叠的图标
        }

        // 可选：根据侧边栏状态调整编辑器宽度等
        const editor = document.querySelector('.code-editor');
        const toolbar = document.querySelector('.toolbar');
        if (sidebar.classList.contains('collapsed')) {
            // 把编辑器宽度调整为全屏
            editor.style.marginLeft = "0px";
            toolbar.style.marginLeft = "0px";
        } else {
            // 还原编辑器的宽度，减去侧边栏的宽度
            editor.style.marginLeft = "200px";
            toolbar.style.marginLeft = "200px";
        }

        // 调整完大小后刷新CodeMirror实例
        window.editor.refresh();

    }


</script>
<script>
    document.getElementById('search-input').addEventListener('input', function() {
        const filter = this.value.toUpperCase();
        const titles = document.querySelectorAll('.titles li');

        titles.forEach(title => {
            const text = title.textContent || title.innerText;
            if (text.toUpperCase().indexOf(filter) > -1) {
                title.style.display = "";
            } else {
                title.style.display = "none";
            }
        });
    });
</script>

</body>
</html>
